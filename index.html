<!DOCTYPE html>
<html>
<head>
<title>Daily Dispatch Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="refresh" content="180">

<style>
body{margin:0;font-family:Arial;background:black;color:white;}
header{display:flex;justify-content:space-between;align-items:center;padding:20px;}
h1{font-size:38px;}
#totalQty{font-size:28px;color:lightgreen;}

table{width:95%;margin:auto;border-collapse:collapse;font-size:20px;}
th,td{border:2px solid white;padding:6px;text-align:center;}
th{background:#333;}

.overdue{background:red;animation:blink 1s infinite;}
@keyframes blink{50%{opacity:0.4;}}

#wrap{height:55vh;overflow:hidden;}
#scroll{animation:scrollUp 35s linear infinite;}
@keyframes scrollUp{
  0%{transform:translateY(100%);}
  100%{transform:translateY(-100%);}
}

#summary{padding:15px;font-size:18px;}
</style>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(loadData);

function parseDate(val){
  if(!val) return null;
  if(val instanceof Date) return val;

  const parts = val.toString().split("-");
  if(parts.length!==2) return null;

  const day = parseInt(parts[0]);
  const month = new Date(Date.parse(parts[1]+" 1, 2024")).getMonth();
  const year = new Date().getFullYear();

  return new Date(year, month, day);
}

function loadData(){
  const query = new google.visualization.Query(
    "https://docs.google.com/spreadsheets/d/1-MzOK58kPnIZInwA4tXSTo3-LNIplSvSXSGZoiMRjb4/gviz/tq?sheet=DAILY%20DISPATCH%20PLAN"
  );

  query.send(res=>{
    if(res.isError()){
      document.getElementById("totalQty").innerText="Data load error";
      return;
    }

    const data=res.getDataTable();
    const today=new Date(); today.setHours(0,0,0,0);

    let total=0, summary={}, rows=[];

    for(let i=0;i<data.getNumberOfRows();i++){
      const qty = Number(data.getValue(i,5));
      const rawDate = data.getValue(i,6);
      const date = parseDate(rawDate);
      const cust = data.getValue(i,1);

      if(!qty || !date) continue;   // skip empty row

      total+=qty;
      summary[cust]=(summary[cust]||0)+qty;

      rows.push([
        data.getValue(i,0),
        cust,
        data.getValue(i,2),
        data.getValue(i,3),
        data.getValue(i,4),
        qty,
        date.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}),
        date<today
      ]);
    }

    rows.sort((a,b)=>new Date(a[6])-new Date(b[6]));

    document.getElementById("totalQty").innerText="Total Qty: "+total;

    let html="<table><tr><th>Sl.No</th><th>Customer</th><th>Item Code</th><th>Item Name</th><th>Product</th><th>Qty</th><th>Dispatch Date</th></tr>";
    rows.forEach(r=>{
      html+=`<tr class="${r[7]?'overdue':''}">
      <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>
      <td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td>
      <td>${r[6]}</td></tr>`;
    });
    html+="</table>";
    document.getElementById("scroll").innerHTML=html;

    let s="<b>Customer-wise Qty:</b><br>";
    for(let k in summary) s+=`${k}: ${summary[k]} | `;
    document.getElementById("summary").innerHTML=s;
  });
}
</script>
</head>

<body>

<header>
<h1>DAILY DISPATCH PLAN</h1>
<div id="totalQty">Loading...</div>
</header>

<div id="wrap"><div id="scroll"></div></div>
<div id="summary"></div>

</body>
</html>
