<!DOCTYPE html>
<html>
<head>
<title>Daily Dispatch Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="refresh" content="180">

<style>
body{margin:0;font-family:Arial;background:black;color:white;}
header{display:flex;justify-content:space-between;align-items:center;padding:20px;}
h1{font-size:38px;}
#totalQty{font-size:28px;color:lightgreen;}

table{width:95%;margin:auto;border-collapse:collapse;font-size:20px;}
th,td{border:2px solid white;padding:6px;text-align:center;}
th{background:#333;}

.overdue{background:red;animation:blink 1s infinite;}
@keyframes blink{50%{opacity:0.4;}}

#wrap{height:55vh;overflow:hidden;}
#scroll{animation:scrollUp 35s linear infinite;}
@keyframes scrollUp{
  0%{transform:translateY(100%);}
  100%{transform:translateY(-100%);}
}

#summary{padding:15px;font-size:18px;}
</style>

<script>
// Fetch and render CSV
const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT04b2M0n-rrLlRUMu6JFJP5dxHBSQ8-4m45W47nxwwLUBDs1INcHO6jswUCnk3kp57AP3tQq19qccF/pub?output=csv";

// CSV parser
function parseCSV(text){
    const rows = [];
    let row = [], quote = false, cell = "";
    for(let i=0; i<text.length; i++){
        const ch = text[i];
        if(ch === '"') { quote = !quote; }
        else if(ch === ',' && !quote){
            row.push(cell); cell = "";
        }
        else if(ch === '\n' && !quote){
            row.push(cell); rows.push(row);
            row = []; cell = "";
        }
        else { cell += ch; }
    }
    if(cell) row.push(cell);
    if(row.length) rows.push(row);
    return rows;
}

function parseDate(val){
    if(!val) return null;
    const parts = val.trim().split("-");
    if(parts.length !== 2) return null;
    const day = parseInt(parts[0]);
    const mon = new Date(Date.parse(parts[1]+" 1, 2024")).getMonth();
    const year = new Date().getFullYear();
    return new Date(year, mon, day);
}

fetch(sheetURL)
.then(res => res.text())
.then(txt => {
    const data = parseCSV(txt.trim());
    const header = data.shift(); // remove header

    let totalQty = 0, summary = {}, rows = [];
    const today = new Date(); today.setHours(0,0,0,0);

    data.forEach(r => {
        const qty = parseInt(r[5]) || 0;
        const date = parseDate(r[6]);
        if(!qty || !date) return;

        totalQty += qty;
        summary[r[1]] = (summary[r[1]]||0) + qty;
        rows.push([r[0], r[1], r[2], r[3], r[4], qty, date]);
    });

    rows.sort((a,b) => a[6] - b[6]);

    document.getElementById("totalQty").innerText = "Total Qty: " + totalQty;

    let tableHTML = "<table><tr>";
    tableHTML += "<th>Sl.No</th><th>Customer</th><th>Item Code</th><th>Item Name</th><th>Product</th><th>Qty</th><th>Dispatch Date</th></tr>";

    rows.forEach(r => {
        const overdue = (r[6] < today) ? "overdue" : "";
        const dStr = r[6].toLocaleDateString("en-GB",{day:"2-digit",month:"short"});
        tableHTML += `<tr class="${overdue}"><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${dStr}</td></tr>`;
    });
    tableHTML += "</table>";

    document.getElementById("scroll").innerHTML = tableHTML;

    let summHTML = "<b>Customer-wise Qty Summary:</b><br>";
    for(let c in summary){
        summHTML += `${c}: ${summary[c]} | `;
    }
    document.getElementById("summary").innerHTML = summHTML;

})
.catch(err => {
    document.body.innerHTML = "<h2 style='color:red;text-align:center'>DATA LOAD ERROR</h2>";
    console.error(err);
});
</script>

</head>
<body>

<header>
<h1>DAILY DISPATCH PLAN</h1>
<div id="totalQty">Loading...</div>
</header>

<div id="wrap"><div id="scroll"></div></div>
<div id="summary"></div>

</body>
</html>
